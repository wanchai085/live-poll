<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ผลโหวตและเหตุผล (สด)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .container { display: flex; flex-wrap: wrap; gap: 20px; max-width: 1300px; margin: auto; }
        .main-column { flex: 2; min-width: 320px; display: flex; flex-direction: column; gap: 20px; }
        .side-column { flex: 1; min-width: 300px; }
        .card { background-color: white; padding: 25px 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        h2 { margin-top: 0; color: #2c3e50; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; }
        .results { margin-top: 20px; }
        .result-item { margin-bottom: 15px; }
        .result-label { display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: bold; }
        .result-bar-container { background-color: #ecf0f1; border-radius: 5px; height: 20px; }
        .result-bar-inner { height: 100%; width: 0%; border-radius: 5px; transition: width 0.5s ease-in-out; }
        .reasons-container { height: 50vh; display: flex; flex-direction: column; }
        .reasons-feed { overflow-y: auto; flex-grow: 1; padding-right: 10px; }
        .reason-card { border: 1px solid #e0e0e0; border-left-width: 5px; border-radius: 8px; padding: 15px; margin-bottom: 15px; animation: fadeIn 0.5s; }
        .reason-card p { margin: 0; font-size: 1.1em; word-wrap: break-word; }
        .reason-card small { color: #888; display: block; margin-top: 5px;}
        .other-votes-list { list-style-type: none; padding: 0; }
        .other-votes-list li { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0; font-size: 1.1em; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <div class="main-column">
        <div class="card poll-container">
            <h2>ผลโหวตสด: กำแพงที่ใหญ่ที่สุดคือ?</h2>
            <div class="results">
                <!-- ผลลัพธ์ตัวเลือกหลัก -->
                <div class="result-item"><div class="result-label"><span>เวลา</span><span id="option1-count">0 โหวต</span></div><div class="result-bar-container"><div id="option1-bar" class="result-bar-inner" style="background-color: #3498db;"></div></div></div>
                <div class="result-item"><div class="result-label"><span>ความกลัว</span><span id="option2-count">0 โหวต</span></div><div class="result-bar-container"><div id="option2-bar" class="result-bar-inner" style="background-color: #e74c3c;"></div></div></div>
                <div class="result-item"><div class="result-label"><span>การสนับสนุน</span><span id="option3-count">0 โหวต</span></div><div class="result-bar-container"><div id="option3-bar" class="result-bar-inner" style="background-color: #2ecc71;"></div></div></div>
            </div>
        </div>
        <div class="card other-votes-container">
             <h2>อุปสรรคอื่นๆ ที่ถูกเสนอ</h2>
             <ul class="other-votes-list" id="other-votes-list">
                <!-- รายการ "อื่นๆ" จะแสดงที่นี่ -->
             </ul>
        </div>
    </div>
    <div class="side-column">
        <div class="card reasons-container">
            <h2>เหตุผลประกอบ (ล่าสุด)</h2>
            <div class="reasons-feed" id="reasons-feed">
                <!-- ฟีดเหตุผล -->
            </div>
        </div>
    </div>
</div>

    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        const firebaseConfig = { /* ... วาง Config เดิมของคุณ ... */ };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // 1. ฟังคะแนนโหวตหลัก
        database.ref('votes').on('value', snapshot => {
            const votes = snapshot.val() || {};
            updateVoteCounts(votes);
        });

        // 2. ฟังเหตุผลใหม่ๆ
        database.ref('reasons').orderByChild('timestamp').limitToLast(30).on('child_added', snapshot => {
            addReasonToFeed(snapshot.val());
        });

        // 3. ฟังคะแนนโหวต "อื่นๆ"
        database.ref('other_votes').orderByChild('count').on('value', snapshot => {
            updateOtherVotes(snapshot.val());
        });

        function updateVoteCounts(votes) {
            const mainVotes = {
                option1: votes.option1 || 0,
                option2: votes.option2 || 0,
                option3: votes.option3 || 0
            };
            const totalVotes = Object.values(mainVotes).reduce((a, b) => a + b, 0);

            for (const key in mainVotes) {
                const count = mainVotes[key];
                const percentage = totalVotes === 0 ? 0 : Math.round((count / totalVotes) * 100);
                document.getElementById(`${key}-count`).innerText = `${count} โหวต (${percentage}%)`;
                document.getElementById(`${key}-bar`).style.width = `${percentage}%`;
            }
        }

        function addReasonToFeed(data) {
            const feedContainer = document.getElementById('reasons-feed');
            const card = document.createElement('div');
            card.className = 'reason-card';
            
            const text = document.createElement('p');
            text.innerText = `“${data.reason}”`;
            
            const meta = document.createElement('small');
            meta.innerText = `จากคนที่เลือก: ${data.optionText}`;
            
            card.appendChild(text);
            card.appendChild(meta);
            feedContainer.prepend(card);
        }

        function updateOtherVotes(votes) {
            const list = document.getElementById('other-votes-list');
            list.innerHTML = ''; // ล้างรายการเก่า
            if (!votes) return;

            // แปลง object เป็น array แล้วเรียงจากมากไปน้อย
            const sortedVotes = Object.values(votes).sort((a, b) => b.count - a.count);

            sortedVotes.forEach(vote => {
                const item = document.createElement('li');
                const textSpan = document.createElement('span');
                textSpan.innerText = vote.text;
                const countSpan = document.createElement('span');
                countSpan.innerText = `${vote.count} โหวต`;
                
                item.appendChild(textSpan);
                item.appendChild(countSpan);
                list.appendChild(item);
            });
        }
    </script>
</body>
</html>
