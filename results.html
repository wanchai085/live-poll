<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ผลโหวตและเหตุผล (สด)</title>
    <style>
        /* CSS styling (ปรับปรุงใหม่) */
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .container { display: flex; flex-wrap: wrap; gap: 20px; max-width: 1200px; margin: auto; }
        .poll-container, .reasons-container { background-color: white; padding: 25px 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .poll-container { flex: 1; min-width: 300px; }
        .reasons-container { flex: 2; min-width: 300px; height: 80vh; display: flex; flex-direction: column; }
        h2 { margin-top: 0; color: #2c3e50; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; }
        .results { margin-top: 20px; }
        .result-item { margin-bottom: 15px; }
        .result-label { display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: bold; }
        .result-bar-container { background-color: #ecf0f1; border-radius: 5px; height: 20px; }
        .result-bar-inner { height: 100%; width: 0%; border-radius: 5px; transition: width 0.5s ease-in-out; }
        /* Styling for Reasons Feed */
        .reasons-feed { overflow-y: auto; flex-grow: 1; padding-right: 10px; }
        .reason-card { border: 1px solid #e0e0e0; border-left-width: 5px; border-radius: 8px; padding: 15px; margin-bottom: 15px; animation: fadeIn 0.5s ease; }
        .reason-card.option1 { border-left-color: #3498db; } /* เวลา */
        .reason-card.option2 { border-left-color: #e74c3c; } /* ความกลัว */
        .reason-card.option3 { border-left-color: #2ecc71; } /* การสนับสนุน */
        .reason-card p { margin: 0; font-size: 1.1em; word-wrap: break-word; }
        .reason-card small { color: #888; display: block; margin-top: 5px;}
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <div class="poll-container">
        <h2>ผลโหวตสด: กำแพงที่ใหญ่ที่สุดคือ?</h2>
        <div class="results">
            <!-- ผลลัพธ์ของตัวเลือกที่ 1 -->
            <div class="result-item">
                <div class="result-label"><span>เวลา</span><span id="option1-count">0 โหวต</span></div>
                <div class="result-bar-container"><div id="option1-bar" class="result-bar-inner" style="background-color: #3498db;"></div></div>
            </div>
            <!-- ผลลัพธ์ของตัวเลือกที่ 2 -->
            <div class="result-item">
                <div class="result-label"><span>ความกลัว</span><span id="option2-count">0 โหวต</span></div>
                <div class="result-bar-container"><div id="option2-bar" class="result-bar-inner" style="background-color: #e74c3c;"></div></div>
            </div>
            <!-- ผลลัพธ์ของตัวเลือกที่ 3 -->
            <div class="result-item">
                <div class="result-label"><span>การสนับสนุน</span><span id="option3-count">0 โหวต</span></div>
                <div class="result-bar-container"><div id="option3-bar" class="result-bar-inner" style="background-color: #2ecc71;"></div></div>
            </div>
        </div>
    </div>

    <div class="reasons-container">
        <h2>เหตุผลประกอบ (ล่าสุด)</h2>
        <div class="reasons-feed" id="reasons-feed">
            <!-- เหตุผลจะถูกเพิ่มเข้ามาที่นี่ด้วย JavaScript -->
        </div>
    </div>
</div>

    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCm5VlyrkTWe4IT2FgTCwkxWaDb7qNmgY8",
            authDomain: "my-live-poll-1be77.firebaseapp.com",
            databaseURL: "https://my-live-poll-1be77-default-rtdb.firebaseio.com",
            projectId: "my-live-poll-1be77",
            storageBucket: "my-live-poll-1be77.firebasestorage.app",
            messagingSenderId: "436007953959",
            appId: "1:436007953959:web:bbd1f457cee48d79f89002",
            measurementId: "G-HG9LJMG3NN"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- 1. ฟังการเปลี่ยนแปลงของ "คะแนนรวม" ---
        const votesRef = database.ref('votes');
        votesRef.on('value', (snapshot) => {
            const votes = snapshot.val() || { option1: 0, option2: 0, option3: 0 };
            updateVoteCounts(votes);
        });

        // --- 2. ฟัง "เหตุผลใหม่" ที่เพิ่มเข้ามา ---
        const reasonsRef = database.ref('reasons').orderByChild('timestamp').limitToLast(30); // แสดง 30 เหตุผลล่าสุด
        reasonsRef.on('child_added', (snapshot) => {
            const reasonData = snapshot.val();
            addReasonToFeed(reasonData);
        });

        function updateVoteCounts(votes) {
            const totalVotes = (votes.option1 || 0) + (votes.option2 || 0) + (votes.option3 || 0);
            const options = ['option1', 'option2', 'option3'];

            options.forEach(key => {
                const count = votes[key] || 0;
                const percentage = totalVotes === 0 ? 0 : Math.round((count / totalVotes) * 100);
                document.getElementById(`${key}-count`).innerText = `${count} โหวต (${percentage}%)`;
                document.getElementById(`${key}-bar`).style.width = `${percentage}%`;
            });
        }

        function addReasonToFeed(data) {
            const feedContainer = document.getElementById('reasons-feed');
            const card = document.createElement('div');
            card.className = `reason-card ${data.option}`;
            
            const text = document.createElement('p');
            text.innerText = `“${data.text}”`; // ใส่เครื่องหมายคำพูด
            
            const time = new Date(data.timestamp).toLocaleTimeString('th-TH');
            const meta = document.createElement('small');
            meta.innerText = `โหวตเมื่อ: ${time}`;

            card.appendChild(text);
            card.appendChild(meta);
            
            // เพิ่มเหตุผลใหม่ไว้บนสุด
            feedContainer.prepend(card);
        }
    </script>
</body>
</html>
